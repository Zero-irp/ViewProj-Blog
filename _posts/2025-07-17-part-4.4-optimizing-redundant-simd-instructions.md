---
layout: post
title: "4.4: Optimizing Redundant SIMD Instructions"
date: 2025-07-17 00:00:00 +0530
permalink: /part-4.4-optimizing-redundant-simd-instructions/
---

<style>
.asm64-code {
  background: #1e1e1e;
  color: #c5c8c6;
  padding: 12px;
  border-radius: 8px;
  font-family: "Cascadia Code", Consolas, "Liberation Mono", Menlo, monospace;
  font-size: 14px;
  line-height: 1.45;
  overflow-x: auto;
  white-space: pre;
}

/* Assembly token styles */
.asm64-code .kw     { color: #d78700; font-weight: 600; }   /* opcodes like mov, add */
.asm64-code .reg    { color: #5fafaf; }                     /* registers like rax, rcx */
.asm64-code .mem    { color: #af87d7; }                     /* memory refs like [rbx+8] */
.asm64-code .num    { color: #b5cea8; }                     /* numbers / hex */
.asm64-code .label  { color: #ffaf5f; }                     /* labels or jumps */
.asm64-code .comment{ color: #6a9955; font-style: italic; } /* comments */
.asm64-code .const  { color: #ce9178; }                     /* static strings or constants */
</style>


<style>
.ida-code{
  background:#1e1e1e;
  color:#dcdcdc;
  padding:12px;
  border-radius:8px;
  font-family: Consolas, "Liberation Mono", Menlo, monospace;
  font-size:14px;
  line-height:1.4;
  overflow-x:auto;
  white-space: pre; /* preserve spaces and linebreaks */
}

/* token classes you can use inside the div */
.ida-code .kw    { color:#569cd6; } /* keywords */
.ida-code .type  { color:#4ec9b0; } /* types */
.ida-code .fn    { color:#dcdcaa; } /* functions / intrinsics */
.ida-code .num   { color:#b5cea8; } /* numbers / hex */
.ida-code .var   { color:#9cdcfe; } /* variables */
.ida-code .const { color:#ce9178; } /* globals / constants */
.ida-code .comment{ color:#6a9955; font-style:italic; }
</style>

Now it's time to optimize all the redundant SIMD operations we have seen till now.
> Expect no performance gain this is only for a learning experience.

Just for a refresher we took a bottom up approach on finding functions responsible for finding the Construction Function.  

**Function traced back from:**  

sub_9AA040->sub_sub_7FBF10->sub_7FD060

Let's First try to optimize sub_7FD060 which we previously renamed to ProjXViewMul.  

The redundant or overly complicated SIMD function was:  

 <div class="ida-code"> <span class="var">v16</span>[<span class="num">3</span>] = <span class="fn">_mm_add_ps</span>(
             <span class="fn">_mm_add_ps</span>(
               <span class="fn">_mm_add_ps</span>(
		 <span class="fn">_mm_mul_ps</span>(<span class="fn">_mm_shuffle_ps</span>((<span class="type">__m128</span>)<span class="var">Mask_0001f</span>, (<span class="type">__m128</span>)<span class="var">Mask_0001f</span>, <span class="num">0</span>), <span class="var">ProjMat_0</span>), 
		 <span class="fn">_mm_mul_ps</span>(<span class="fn">_mm_shuffle_ps</span>((<span class="type">__m128</span>)<span class="var">Mask_0001f</span>, (<span class="type">__m128</span>)<span class="var">Mask_0001f</span>, <span class="num">0x55</span>), <span class="var">ProjMat_1</span>)),
               <span class="fn">_mm_mul_ps</span>(<span class="fn">_mm_shuffle_ps</span>((<span class="type">__m128</span>)<span class="var">Mask_0001f</span>, (<span class="type">__m128</span>)<span class="var">Mask_0001f</span>, <span class="num">0xAA</span>), <span class="var">ProjMat_2</span>)),
             <span class="fn">_mm_mul_ps</span>(<span class="fn">_mm_shuffle_ps</span>((<span class="type">__m128</span>)<span class="var">Mask_0001f</span>, (<span class="type">__m128</span>)<span class="var">Mask_0001f</span>, <span class="num">0xFF</span>), <span class="var">ProjMat_3</span>));
</div>

we can change this to achieve the same functionality by simply doing:

<div class="ida-code"> <span class="var">v16</span>[<span class="num">3</span>] = <span class="var">ProjMat_3</span>
</div>

But we cannot just type it into pseudo code, we need to patch it manually in assembly.  

### Finding Assembly responsible for this function:

To find assembly instructions corresponds to out pseudo-code we will use IDA's synchronize function.  

![ESP-Image1](/ViewProj-Blog/assets/images/part-4.4/synchronize_ida.png)

Highlighting what we are looking for:

![ESP-Image1](/ViewProj-Blog/assets/images/part-4.4/synchronize_selection_ida.png)

Now we see the corresponding assembly:  

![ESP-Image1](/ViewProj-Blog/assets/images/part-4.4/synchronize_ida_asm.png)

here i will just do the quick and easy method of nopping out every instruction we don't need, see which xmm register holds ProjMat_3 
and simply storing it:  

<div class="asm64-code"><span class="kw">movaps</span> <span class="reg">v16</span>[3], <span class="reg">xmm</span>
</div>

Let's see which xmm register holds ProjMat_3 

<div class="ida-code"><span class="var">ProjMat_3</span> = *(<span class="type">__m128</span>*)(<span class="var">camStruct</span> + <span class="num">0x230</span>);
</div>

Highlight this like before and we see it corresponds to:

<div class="asm64-code"><span class="kw">movups</span> <span class="reg">xmm10</span>, <span class="reg">xmmword ptr</span> <span class="mem">[rcx+230h]</span> 
</div>

making sure xmm10 is not changed along the way and we can just store it directly at:

![ESP-Image1](/ViewProj-Blog/assets/images/part-4.4/v16_storing.png)

xmm11 is the calculated output of the enitre Vec4 x Mat4x4, chaning this to xmm10 will achive the same function.  

we will nop out all other instructions:  

### Nopping Instructions:

<div class="asm64-code"><span class="kw">movups</span>  <span class="reg">xmm4</span>, <span class="mem">cs:Mask_0001f</span>
<span class="kw">movaps</span>  <span class="reg">xmm11</span>, <span class="reg">xmm4</span>
<span class="kw">shufps</span>  <span class="reg">xmm11</span>, <span class="reg">xmm4</span>, <span class="num">0</span>
<span class="kw">movaps</span>  <span class="reg">xmm0</span>, <span class="reg">xmm4</span>
<span class="kw">mulps</span>   <span class="reg">xmm11</span>, <span class="reg">xmm6</span>
<span class="kw">shufps</span>  <span class="reg">xmm0</span>, <span class="reg">xmm4</span>, <span class="num">55h</span> <span class="comment">; 'U'</span>
<span class="kw">mulps</span>   <span class="reg">xmm0</span>, <span class="reg">xmm7</span>
<span class="kw">movaps</span>  <span class="reg">xmm1</span>, <span class="reg">xmm4</span>
<span class="kw">shufps</span>  <span class="reg">xmm1</span>, <span class="reg">xmm4</span>, <span class="num">0AAh</span>
<span class="kw">addps</span>   <span class="reg">xmm11</span>, <span class="reg">xmm0</span>
<span class="kw">mulps</span>   <span class="reg">xmm1</span>, <span class="reg">xmm9</span>
<span class="kw">shufps</span>  <span class="reg">xmm4</span>, <span class="reg">xmm4</span>, <span class="num">0FFh</span>
<span class="kw">addps</span>   <span class="reg">xmm11</span>, <span class="reg">xmm1</span>
<span class="kw">mulps</span>   <span class="reg">xmm4</span>, <span class="reg">xmm10</span>
<span class="kw">addps</span>   <span class="reg">xmm11</span>, <span class="reg">xmm4</span>
</div>

all these are going to nopped out.

Now we are going to nop all these out and change xmm11 to xmm10 in the final movaps in cheat engine and see if it works as intended.  

![ESP-Image1](/ViewProj-Blog/assets/images/part-4.4/assembly_patch_v16.png)

![ESP-Image1](/ViewProj-Blog/assets/images/part-4.4/ce_nops.png)

### Result?

Game runs as we suspected without any artifacts in game or in UI:  

![ESP-Image1](/ViewProj-Blog/assets/images/part-4.4/game_runs.gif)


























